#!/bin/bash
#===============================================================================
# BMAD Pre-Commit Hook
#
# Purpose: Verify gates pass before allowing commits
# Install: Copy to .git/hooks/pre-commit and chmod +x
#
# This hook:
# 1. Finds modified story files
# 2. Checks if any are being marked as "done"
# 3. Runs gates to verify the claim
# 4. Blocks commit if gates fail
#===============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${YELLOW}[BMAD]${NC} $1"; }
log_success() { echo -e "${GREEN}[BMAD]${NC} $1"; }
log_error() { echo -e "${RED}[BMAD]${NC} $1"; }

# Find gate runner
GATE_RUNNER=""
if [[ -f "_bmad/core/verification/gate-runner.sh" ]]; then
    GATE_RUNNER="_bmad/core/verification/gate-runner.sh"
elif [[ -f "$(dirname "$0")/../../_bmad/core/verification/gate-runner.sh" ]]; then
    GATE_RUNNER="$(dirname "$0")/../../_bmad/core/verification/gate-runner.sh"
fi

if [[ -z "$GATE_RUNNER" ]]; then
    log_info "Gate runner not found, skipping verification"
    exit 0
fi

# Check for staged story files with status changes
STORY_FILES=$(git diff --cached --name-only | grep -E '\.(yaml|yml)$' | grep -E '(story|US-|task)' || true)

if [[ -z "$STORY_FILES" ]]; then
    # No story files being committed, allow
    exit 0
fi

log_info "Checking story files for status changes..."

BLOCKED=false

for story_file in $STORY_FILES; do
    if [[ ! -f "$story_file" ]]; then
        continue
    fi

    # Check if status is being changed to "done"
    OLD_STATUS=$(git show "HEAD:$story_file" 2>/dev/null | grep "^status:" | awk '{print $2}' || echo "pending")
    NEW_STATUS=$(grep "^status:" "$story_file" | awk '{print $2}' || echo "pending")

    if [[ "$NEW_STATUS" == "done" && "$OLD_STATUS" != "done" ]]; then
        log_info "Story $story_file marked as done - verifying gates..."

        # Check if all_gates_passed is true
        GATES_PASSED=$(grep "all_gates_passed:" "$story_file" | awk '{print $2}' || echo "false")

        if [[ "$GATES_PASSED" != "true" ]]; then
            log_error "BLOCKED: $story_file"
            log_error "  Status set to 'done' but all_gates_passed is not true"
            log_error "  Run: bash $GATE_RUNNER --story $story_file"
            BLOCKED=true
        else
            # Verify by running gates again
            log_info "Running gate verification..."
            if bash "$GATE_RUNNER" --story "$story_file" --once; then
                log_success "Gates verified for $story_file"
            else
                log_error "BLOCKED: Gates failed for $story_file"
                BLOCKED=true
            fi
        fi
    fi
done

if [[ "$BLOCKED" == "true" ]]; then
    log_error "========================================"
    log_error "COMMIT BLOCKED: Verification gates failed"
    log_error "========================================"
    log_error ""
    log_error "A story was marked 'done' but gates did not pass."
    log_error "This prevents fake deliverables from being committed."
    log_error ""
    log_error "To fix:"
    log_error "  1. Run the gate runner to see what's failing"
    log_error "  2. Fix the issues"
    log_error "  3. Re-run gates until they pass"
    log_error "  4. Try commit again"
    log_error ""
    log_error "To bypass (NOT RECOMMENDED):"
    log_error "  git commit --no-verify"
    log_error ""
    exit 1
fi

log_success "All verification checks passed"
exit 0
