---
name: task-queue-system
description: Documentation for the 24-hour autonomous coding task queue system. Based on Leon van Zyl's methodology and Anthropic's effective agent harness.
---

# Task Queue System for Autonomous Coding

**Based on:** Leon van Zyl's "I Let Claude Code Run for 24 Hours"
**Reference:** https://github.com/leonvanzyl/autonomous-coding
**Methodology:** Anthropic's Effective Agent Harness

---

## Overview

The Task Queue System enables **long-running autonomous development** without hitting context window limits. Each task runs in isolation, with context cleared between tasks.

```
┌─────────────────────────────────────────────────────────────┐
│                    TASK QUEUE ARCHITECTURE                   │
└─────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────┐
     │           INITIALIZATION AGENT (Opus)               │
     │  • Parse feature list from spec file                │
     │  • Create prioritized task queue                    │
     │  • Setup project structure                          │
     │  • Generate task dependencies graph                 │
     └─────────────────────────────────────────────────────┘
                              │
                              ▼
     ┌─────────────────────────────────────────────────────┐
     │              CODING AGENT LOOP (Sonnet)             │
     │                                                     │
     │   while (tasks_remaining):                          │
     │     1. Pick next task from queue                    │
     │     2. Implement feature                            │
     │     3. Run tests                                    │
     │     4. If tests pass:                               │
     │        - Git commit                                 │
     │        - Clear context                              │
     │        - Send progress notification                 │
     │     5. If tests fail:                               │
     │        - Debug and retry (max 3 attempts)           │
     │        - If still failing: mark blocked, skip       │
     │     6. Move to next task                            │
     │                                                     │
     └─────────────────────────────────────────────────────┘
```

---

## Task Queue File Format

**Location:** `_bmad-output/nexus-sprint/task-queue.yaml`

```yaml
# Task Queue for Autonomous Development
# Generated by Initialization Agent
# Last Updated: [timestamp]

meta:
  project: Nexus
  total_tasks: 25
  completed: 8
  blocked: 2
  remaining: 15

queue:
  - id: task_001
    name: "Implement user authentication"
    status: completed  # pending | in_progress | completed | blocked | skipped
    priority: 1        # 1 = highest
    estimated_tokens: 50000
    dependencies: []
    assigned_to: null
    started_at: "2026-01-18T10:00:00Z"
    completed_at: "2026-01-18T10:45:00Z"
    commit_hash: "abc123"

  - id: task_002
    name: "Add OAuth integration for Gmail"
    status: in_progress
    priority: 2
    estimated_tokens: 40000
    dependencies: [task_001]
    assigned_to: "@coder"
    started_at: "2026-01-18T10:46:00Z"
    completed_at: null
    commit_hash: null

  - id: task_003
    name: "Build workflow visualization"
    status: pending
    priority: 3
    estimated_tokens: 60000
    dependencies: [task_001, task_002]
    assigned_to: null
    started_at: null
    completed_at: null
    commit_hash: null

  - id: task_004
    name: "Implement Slack webhook handler"
    status: blocked
    priority: 4
    estimated_tokens: 30000
    dependencies: []
    blocked_reason: "Slack API credentials not configured"
    assigned_to: null

blocked_tasks:
  - task_id: task_004
    reason: "Slack API credentials not configured"
    blocked_since: "2026-01-18T09:00:00Z"
    unblock_action: "CEO to provide Slack OAuth credentials"
```

---

## Initialization Agent Protocol

### When to Run
- Start of new development sprint
- After major scope change
- When task queue is empty

### Initialization Steps

```markdown
## INITIALIZATION AGENT ASSIGNMENT

1. READ the feature specification file:
   - `_bmad-output/nexus-sprint/scope-document.md`
   - OR user-provided feature list

2. PARSE features into discrete tasks:
   - Each task = one logical unit of work
   - Task should be completable in < 100K tokens
   - No task should span multiple files/features

3. ANALYZE dependencies:
   - Which tasks depend on others?
   - Create dependency graph
   - Identify parallelizable tasks

4. PRIORITIZE queue:
   - Critical path tasks first
   - Quick wins (low effort, high impact) early
   - Blocked tasks at end

5. GENERATE task queue file:
   - Output to `_bmad-output/nexus-sprint/task-queue.yaml`
   - Include all metadata

6. REPORT summary to Director:
   - Total tasks: X
   - Estimated time: Y hours
   - Parallelizable: Z tasks
   - Blocked: W tasks (list reasons)
```

---

## Coding Agent Loop Protocol

### For Each Task

```markdown
## CODING AGENT TASK EXECUTION

TASK: [task_name]
TASK_ID: [task_id]

---

### STEP 1: CONTEXT SETUP
- Read task requirements from queue
- Read relevant existing code
- Understand dependencies

### STEP 2: IMPLEMENTATION
- Write code following coding standards
- Keep changes focused on this task only
- No scope creep

### STEP 3: TESTING
- Run: `npm run build` (must pass)
- Run: `npm run test` (if tests exist)
- Verify no console errors

### STEP 4: IF TESTS PASS
```bash
# Git commit
git add -A
git commit -m "feat: [task_name] - Task [task_id]"

# Update task queue
# Mark status: completed
# Record commit_hash
# Record completed_at
```

### STEP 5: IF TESTS FAIL
- Attempt debug (max 3 attempts)
- If still failing after 3 attempts:
  - Mark task as `blocked`
  - Record failure reason
  - Move to next task

### STEP 6: CONTEXT CLEARING
- Task complete, clear context
- Report summary to Director
- Move to next task in queue

---

OUTPUT FORMAT:
```
TASK COMPLETE: [task_id] - [task_name]

STATUS: [completed | blocked]
COMMIT: [hash or N/A]
TESTS: [PASS | FAIL - reason]
CONTEXT: Cleared

NEXT: [next_task_id] - [next_task_name]
```
```

---

## Context Clearing Protocol

### Why Clear Context?

From Leon van Zyl's methodology:
- Each task should start with **fresh context**
- Prevents context pollution between tasks
- Enables truly **long-running** autonomous coding
- Memory persists in **files**, not context

### When to Clear

```
CLEAR CONTEXT AFTER:
✓ Task completed successfully
✓ Task marked as blocked after 3 retries
✓ Manual checkpoint request

DO NOT CLEAR IF:
✗ Task is in progress
✗ Multi-step task (same logical unit)
✗ Review cycle not complete
```

### What Persists After Clear

| Persists | Lost |
|----------|------|
| Git commits | Conversation history |
| Task queue file | Agent reasoning |
| Progress tracker | Temporary variables |
| Scope document | Debug attempts |
| .claude-session.md | Tool outputs |

### Resume Protocol

After context clear, next agent invocation receives:
1. Task queue current state
2. Scope document
3. Last completed task info
4. Any blocked task reasons

---

## Progress Notification Integration

### Webhook Setup (Optional)

For real-time progress monitoring without watching terminal:

```yaml
# .claude/config/notifications.yaml
notifications:
  enabled: true
  webhook_url: "https://your-n8n-instance.com/webhook/nexus-progress"
  events:
    - task_started
    - task_completed
    - task_blocked
    - wave_completed
    - sprint_completed
```

### Notification Payload

```json
{
  "event": "task_completed",
  "timestamp": "2026-01-18T10:45:00Z",
  "project": "Nexus",
  "task": {
    "id": "task_001",
    "name": "Implement user authentication",
    "status": "completed",
    "commit_hash": "abc123",
    "duration_minutes": 45
  },
  "queue_status": {
    "completed": 8,
    "remaining": 15,
    "blocked": 2
  }
}
```

### N8N → Telegram Example

```
N8N Workflow:
1. Webhook Trigger (receive notification)
2. Format message: "✅ Task complete: [name] | 8/25 done | 2 blocked"
3. Telegram Bot: Send to your chat
```

---

## Stop/Resume Capability

### STOP Command

When CEO says "STOP" or "PAUSE":

1. Current task completes (or marks in_progress)
2. Task queue file updated with current state
3. `.claude-session.md` updated with resume instructions
4. Director reports: "Paused at task [X]. Resume with 'CONTINUE'."

### RESUME Command

When CEO says "CONTINUE" or "RESUME":

1. Read task queue file
2. Find first `pending` or `in_progress` task
3. Resume from that task
4. Context is fresh (normal operation)

### Emergency HALT

If something goes wrong:

1. CEO says "HALT" or "EMERGENCY STOP"
2. All agents stop immediately
3. No commit made for in-progress work
4. Director reports current state
5. Manual intervention required to resume

---

## Best Practices

### DO

- ✅ Keep tasks small (< 100K tokens)
- ✅ Clear context after each task
- ✅ Commit after each successful task
- ✅ Track blocked tasks with reasons
- ✅ Use notifications for long-running sprints

### DON'T

- ❌ Run tasks that span multiple features
- ❌ Skip context clearing
- ❌ Ignore test failures
- ❌ Let tasks depend on non-committed work
- ❌ Manually edit task queue file

---

## Integration with CEO-Director Model

The Task Queue System integrates with the CEO-Director Model:

```
CEO sets vision → Director creates scope →
  Initialization Agent parses into task queue →
    Coding Agents execute tasks in loop →
      Ralph validates each task →
        Director monitors and reports to CEO
```

**Director's Role:**
- Monitor task queue progress
- Handle blocked tasks (escalate or skip)
- Report to CEO at milestones
- Manage wave gates

**CEO's Role:**
- Approve initial scope
- Unblock tasks that need credentials/decisions
- STOP/CONTINUE commands
- Review progress at milestones
